{{/* File syntax: https://golang.org/pkg/text/template/ */}}

{{ $CurrentContainer := where $ "ID" .Docker.CurrentContainerID | first }}

# upstreams config

{{ range $host, $containers := groupBy $ "Env.VIRTUAL_HOST" }}

    {{ range $container := $containers }}

upstream {{ $host }} {

      {{ range $knownNetwork := $CurrentContainer.Networks }}
        {{ range $containerNetwork := $container.Networks }}
  	{{ if (or (eq $knownNetwork.Name $containerNetwork.Name) (eq $knownNetwork.Name "host")) }}
	      	  {{ $port := $container.Env.VIRTUAL_PORT }}
		  {{ $address := where $container.Addresses "Port" $port | first }}

    server {{ $containerNetwork.IP }}:{{ $address.Port }};

  	  {{ else }}

    # Cannot connect to network of this container
    server 127.0.0.1 down;

          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

}

{{ end }}

# server config

server {
    listen 80 default_server;
    root  /data;

    location / {
    }
 
    location /files/ {
      autoindex on;
    }

{{ range $host, $containers := groupBy $ "Env.VIRTUAL_HOST"}}

    {{ range $container := $containers }}

    location /{{ $host }}/ {
       rewrite ^/{{ $host }}/(.*)$ /$1 break;
       proxy_pass http://{{ $host }};
    }

    {{end}}

{{end}}

}
